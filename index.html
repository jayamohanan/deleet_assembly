<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerala Administrative Boundaries</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4xn+LwB4V+6K9M6jR6j1Q6oD8Q2uB3Z9R8j6y+r9P6Q8=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-p4xn+LwB4V+6K9M6jR6j1Q6oD8Q2uB3Z9R8j6y+r9P6Q8=" crossorigin=""></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/5Sl21D1c0Q/6B1m41wz4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        #panel-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2;
            background-color: rgba(255, 255, 255, 0.85);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: calc(100% - 20px);
            overflow-y: auto;
            resize: horizontal;
            min-width: 250px;
        }
        .panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }
        .panel:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        .select2-container {
            width: 100% !important;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .button-group button {
            flex-grow: 1;
            padding: 8px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .draw-button {
            background-color: #4CAF50;
            color: white;
        }
        .draw-button:hover {
            background-color: #45a049;
        }
        .clear-button {
            background-color: #f44336;
            color: white;
        }
        .clear-button:hover {
            background-color: #d32f2f;
        }
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .color-picker-container input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            background-color: transparent;
            width: 30px;
            height: 30px;
            cursor: pointer;
            padding: 0;
        }
        .color-picker-container input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .color-picker-container input[type="color"]::-webkit-color-swatch {
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #version-info {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 3;
            font-size: 14px;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
        }
        #popup-container {
            display: none;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .popup-label {
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="panel-container">
        <div class="panel">
            <h4>Base Map</h4>
            <select id="base-map-selector">
                <option value="osm">OpenStreetMap</option>
                <option value="carto-dark">CartoDB Dark</option>
                <option value="carto-light">CartoDB Positron</option>
                <option value="satellite">ESRI Satellite</option>
                <option value="none">Hide Base Map</option>
            </select>
        </div>
        
        <div class="panel" id="district-panel">
            <h4>Districts</h4>
            <select id="district-select" multiple="multiple"></select>
            <div class="color-picker-container">
                <span>Outline Color:</span>
                <input type="color" id="district-outline-color" value="#000000">
            </div>
            <div class="color-picker-container">
                <span>Fill Color:</span>
                <input type="color" id="district-fill-color" value="#000000">
            </div>
            <label for="district-transparency">Fill Transparency:</label>
            <input type="range" id="district-transparency" min="0" max="1" step="0.01" value="1">
            <div class="button-group">
                <button class="draw-button" onclick="drawBoundaries('district')">Draw</button>
                <button class="clear-button" onclick="clearBoundaries('district')">Clear</button>
            </div>
        </div>

        <div class="panel" id="assembly-panel">
            <h4>Assemblies</h4>
            <select id="assembly-select" multiple="multiple"></select>
            <div class="color-picker-container">
                <span>Outline Color:</span>
                <input type="color" id="assembly-outline-color" value="#000000">
            </div>
            <div class="color-picker-container">
                <span>Fill Color:</span>
                <input type="color" id="assembly-fill-color" value="#000000">
            </div>
            <label for="assembly-transparency">Fill Transparency:</label>
            <input type="range" id="assembly-transparency" min="0" max="1" step="0.01" value="1">
            <div class="button-group">
                <button class="draw-button" onclick="drawBoundaries('assembly')">Draw</button>
                <button class="clear-button" onclick="clearBoundaries('assembly')">Clear</button>
            </div>
        </div>
    </div>
    
    <div id="version-info">v1.0.0</div>

    <script>
        const VERSION = "1.0.0";
        document.getElementById("version-info").innerText = `v${VERSION}`;

        const config = {
            district: {
                url: 'district_V15.geojson',
                geojson: null,
                layerGroup: new L.LayerGroup(),
                selectId: '#district-select',
                outlineColorId: '#district-outline-color',
                fillColorId: '#district-fill-color',
                transparencyId: '#district-transparency',
                primaryKey: 'Name'
            },
            assembly: {
                url: 'assembly_V15.geojson',
                geojson: null,
                layerGroup: new L.LayerGroup(),
                selectId: '#assembly-select',
                outlineColorId: '#assembly-outline-color',
                fillColorId: '#assembly-fill-color',
                transparencyId: '#assembly-transparency',
                primaryKey: 'Name'
            }
        };

        const map = L.map('map').setView([10.8505, 76.2711], 8);

        let currentBaseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        const baseLayers = {
            'osm': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }),
            'carto-dark': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CartoDB</a>'
            }),
            'carto-light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CartoDB</a>'
            }),
            'satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            })
        };

        document.getElementById('base-map-selector').addEventListener('change', function(e) {
            const selectedValue = e.target.value;
            map.removeLayer(currentBaseLayer);
            if (selectedValue !== 'none') {
                currentBaseLayer = baseLayers[selectedValue].addTo(map);
            }
        });

        const drawnLayers = {
            district: config.district.layerGroup.addTo(map),
            assembly: config.assembly.layerGroup.addTo(map)
        };
        
        // Define the hierarchy for drawing and click events
        const overlayOrder = ['district', 'assembly'];

        async function fetchAndPopulate(type) {
            try {
                const response = await fetch(config[type].url);
                config[type].geojson = await response.json();
                const names = config[type].geojson.features
                    .map(feature => feature.properties[config[type].primaryKey])
                    .filter(name => name)
                    .sort();
                
                const selectElement = $(config[type].selectId);
                selectElement.empty();
                names.forEach(name => {
                    selectElement.append(new Option(name, name));
                });
                
                selectElement.select2({
                    placeholder: `Select ${type}...`,
                    allowClear: true,
                    dropdownParent: $(`#${type}-panel`)
                });
            } catch (error) {
                console.error(`Error fetching or populating ${type} data:`, error);
            }
        }

        fetchAndPopulate('district');
        fetchAndPopulate('assembly');

        function drawBoundaries(type) {
            const selectedNames = $(config[type].selectId).val();
            if (!selectedNames || selectedNames.length === 0) return;

            const outlineColor = document.querySelector(config[type].outlineColorId).value;
            const fillColor = document.querySelector(config[type].fillColorId).value;
            const transparency = document.querySelector(config[type].transparencyId).value;

            const featuresToDraw = config[type].geojson.features.filter(
                f => selectedNames.includes(f.properties[config[type].primaryKey])
            );

            // Temporarily clear and redraw all drawn layers to respect overlay order
            drawnLayers[type].clearLayers();
            featuresToDraw.forEach(feature => {
                const layer = L.geoJSON(feature, {
                    style: {
                        color: outlineColor,
                        weight: 2,
                        opacity: 1,
                        fillColor: fillColor,
                        fillOpacity: transparency
                    },
                    onEachFeature: function(feature, layer) {
                        layer.on('click', function(e) {
                            handleFeatureClick(e, layer, type);
                        });
                        layer.on('mouseover', function(e) {
                            this.bindTooltip(feature.properties[config[type].primaryKey]).openTooltip();
                        });
                    }
                }).addTo(drawnLayers[type]);
            });
        }

        function clearBoundaries(type) {
            drawnLayers[type].clearLayers();
        }

        function handleFeatureClick(e, clickedLayer, clickedType) {
            // Find the topmost layer at the clicked point
            let topmostLayer = null;
            let topmostType = null;
            
            // Check layers in reverse overlay order to find the highest one
            for (let i = overlayOrder.length - 1; i >= 0; i--) {
                const type = overlayOrder[i];
                const layers = drawnLayers[type].getLayers();
                for (let j = 0; j < layers.length; j++) {
                    // Check if the clicked point is within this layer
                    if (layers[j].getBounds().contains(e.latlng)) {
                        topmostLayer = layers[j];
                        topmostType = type;
                        break;
                    }
                }
                if (topmostLayer) break;
            }

            if (!topmostLayer) return;

            // Show a popup for the topmost layer
            const name = topmostLayer.feature.properties[config[topmostType].primaryKey];
            const currentStyle = topmostLayer.options.style;

            const popupContent = L.DomUtil.create('div', 'popup-container');
            popupContent.innerHTML = `
                <h4>${name} (${topmostType.charAt(0).toUpperCase() + topmostType.slice(1)})</h4>
                <div class="color-picker-container">
                    <span>Outline Color:</span>
                    <input type="color" id="popup-outline-color" value="${currentStyle.color}">
                </div>
                <div class="color-picker-container">
                    <span>Fill Color:</span>
                    <input type="color" id="popup-fill-color" value="${currentStyle.fillColor}">
                </div>
                <div>
                    <label for="popup-thickness">Thickness:</label>
                    <input type="range" id="popup-thickness" min="1" max="10" step="1" value="${currentStyle.weight}">
                </div>
                <div>
                    <label for="popup-fill-transparency">Fill Transparency:</label>
                    <input type="range" id="popup-fill-transparency" min="0" max="1" step="0.01" value="${currentStyle.fillOpacity}">
                </div>
            `;
            
            L.popup()
                .setLatLng(e.latlng)
                .setContent(popupContent)
                .openOn(map);

            // Add event listeners for the new inputs
            const popupOutlineColor = popupContent.querySelector('#popup-outline-color');
            const popupFillColor = popupContent.querySelector('#popup-fill-color');
            const popupThickness = popupContent.querySelector('#popup-thickness');
            const popupFillTransparency = popupContent.querySelector('#popup-fill-transparency');

            popupOutlineColor.addEventListener('input', (e) => {
                topmostLayer.setStyle({ color: e.target.value });
            });
            popupFillColor.addEventListener('input', (e) => {
                topmostLayer.setStyle({ fillColor: e.target.value });
            });
            popupThickness.addEventListener('input', (e) => {
                topmostLayer.setStyle({ weight: e.target.value });
            });
            popupFillTransparency.addEventListener('input', (e) => {
                topmostLayer.setStyle({ fillOpacity: e.target.value });
            });
        }
    </script>
</body>
</html>
