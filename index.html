<!-- district-map.html with improved error feedback -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>District Map Drawer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,Arial}
    #app{display:flex;flex-direction:column;height:100%}
    header{padding:12px;background:#0b5;display:flex;gap:8px;align-items:center}
    input[type=text]{padding:8px;border-radius:6px;border:1px solid #ccc;min-width:220px}
    button{padding:8px 12px;border-radius:6px;border:none;background:#075;color:white;cursor:pointer}
    #status{margin-left:8px;font-size:0.95rem;color:#080}
    #map{flex:1}
    #note{padding:6px 12px;color:#900;white-space:pre-line}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <label for="districtInput">District:</label>
      <input id="districtInput" list="districtList" placeholder="Type or choose district name" autocomplete="off">
      <datalist id="districtList"></datalist>
      <button id="drawBtn">Create map</button>
      <div id="status"></div>
    </header>
    <div id="map"></div>
    <div id="note"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const GEOJSON_URL = 'district12_V3.geojson';

    const map = L.map('map', {minZoom: 6}).setView([10.85, 76.27], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    let rawGeo = null;
    let currentLayer = null;

    const input = document.getElementById('districtInput');
    const datalist = document.getElementById('districtList');
    const drawBtn = document.getElementById('drawBtn');
    const status = document.getElementById('status');
    const note = document.getElementById('note');

    function logMessage(msg, isError=false){
      note.style.color = isError ? '#900' : '#060';
      note.textContent = msg;
    }

    status.textContent = 'Loading GeoJSON...';

    fetch(GEOJSON_URL).then(r => {
      if(!r.ok) throw new Error('Failed to load ' + GEOJSON_URL + ' (status '+r.status+')');
      return r.json();
    }).then(gj => {
      rawGeo = gj;
      status.textContent = 'GeoJSON loaded.';
      populateDatalist(gj);
    }).catch(err => {
      status.textContent = '';
      logMessage('Error loading GeoJSON: ' + err.message, true);
      console.error(err);
    });

    const LIKELY_NAME_KEYS = ['NAME','Name','name','DISTRICT','District','district','DISTRICT_NAME','DIST_NAME','NAME_1'];

    function getFeatureName(feature){
      if(!feature || !feature.properties) return null;
      for(const k of LIKELY_NAME_KEYS){
        if(k in feature.properties){
          const v = feature.properties[k];
          if(typeof v === 'string' && v.trim().length>0) return v.trim();
        }
      }
      for(const k in feature.properties){
        const v = feature.properties[k];
        if(typeof v === 'string' && v.trim().length>0) return v.trim();
      }
      return null;
    }

    function populateDatalist(geojson){
      const names = new Set();
      if(!geojson.features){
        logMessage('GeoJSON has no features!', true);
        return;
      }
      for(const f of geojson.features){
        const n = getFeatureName(f);
        if(n) names.add(n);
      }
      if(names.size === 0){
        logMessage('No district names found in GeoJSON.', true);
      }
      Array.from(names).sort().forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        datalist.appendChild(opt);
      });
    }

    function highlightFeatures(query){
      if(!rawGeo){
        logMessage('GeoJSON not loaded yet.', true);
        return;
      }
      if(currentLayer) map.removeLayer(currentLayer);

      const matched = rawGeo.features.filter(f => {
        const n = getFeatureName(f);
        return n && n.toLowerCase() === query.toLowerCase();
      });

      if(matched.length === 0){
        logMessage('No match found for: ' + query, true);
        return;
      }

      currentLayer = L.geoJSON(matched, {
        style: {color: '#0033cc', weight: 2, fillColor: '#66b2ff', fillOpacity: 0.45},
        onEachFeature: (feature, layer) => {
          const n = getFeatureName(feature) || 'Unknown';
          layer.bindPopup('<b>' + n + '</b>');
        }
      }).addTo(map);

      map.fitBounds(currentLayer.getBounds().pad(0.1));
      logMessage('Highlighted district: ' + query);
    }

    drawBtn.addEventListener('click', ()=>{
      const q = input.value.trim();
      if(!q){
        logMessage('Please enter a district name.', true);
        return;
      }
      highlightFeatures(q);
    });

    input.addEventListener('keydown', e => { if(e.key==='Enter'){ drawBtn.click(); } });

    if(location.protocol === 'file:'){
      logMessage('Tip: If GeoJSON fails to load, run a local server (python -m http.server) and open http://localhost:8000/', false);
    }
  </script>
</body>
</html>
