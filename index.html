<!-- version: v1.0.0 -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kerala Boundary Viewer - Static</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2kGk0W1Zr0b6QX2b6Jp5b2PjvY8FQY3vYk1S6mM=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j8+3Xw0rYv1k0Zp2g7qKkO2Y1Y9T9Qw3rYfXc24=" crossorigin=""></script>

  <!-- Choices.js for searchable multi-select -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- tiny color input support (native input type=color used) -->

  <style>
    html,body{height:100%;margin:0;font-family:Arial, Helvetica, sans-serif}
    #map{position:absolute;left:0;top:0;right:320px;bottom:0}
    .sidebar{position:absolute;right:0;top:20px;width:320px;bottom:0;background:rgba(255,255,255,0.95);box-shadow:-2px 0 8px rgba(0,0,0,0.15);padding:16px;overflow:auto}
    .panel{border:1px solid #ddd;padding:10px;margin-bottom:12px;border-radius:8px}
    .panel h3{margin:6px 0 10px 0;font-size:16px}
    .row{display:flex;gap:8px;align-items:center}
    label{font-size:13px}
    .controls{display:flex;flex-direction:column;gap:8px}
    button{padding:8px 10px;border:none;border-radius:6px;cursor:pointer}
    .btn-draw{background:#2b8aef;color:#fff}
    .btn-clear{background:#e74c3c;color:#fff}
    .small{font-size:12px;color:#555}
    .top-right-version{position:fixed;top:6px;right:6px;background:rgba(0,0,0,0.6);color:#fff;padding:6px 8px;border-radius:6px;z-index:9999;font-size:12px}

    /* responsive adjustments */
    @media (max-width:900px){
      #map{right:0;bottom:240px}
      .sidebar{position:fixed;left:0;right:0;bottom:0;top:auto;height:240px;width:auto}
    }

    .form-row{display:flex;gap:8px;align-items:center}
    .form-row input[type="range"]{width:100%}
    .spacer{height:8px}
  </style>
</head>
<body>
  <div class="top-right-version">v1.0.0</div>
  <div id="map"></div>

  <aside class="sidebar" aria-label="Controls">
    <div class="panel">
      <h2 style="margin:0;">Kerala Boundaries (Static)</h2>
      <p class="small">Select features from the GeoJSONs and press Draw. Click shapes on map to customize that tile (overrides panel settings).</p>
      <div class="spacer"></div>
      <div class="form-row">
        <label for="basemap">Base map:</label>
        <select id="basemap" style="flex:1">
          <option value="osm">OpenStreetMap</option>
          <option value="sat">Esri WorldImagery</option>
          <option value="none">No base map (tiles hidden)</option>
        </select>
      </div>
    </div>

    <!-- District panel -->
    <section class="panel" id="district-panel">
      <h3>Districts</h3>
      <div class="controls">
        <label class="small">Choose District(s)</label>
        <select id="district-select" multiple></select>

        <div class="form-row">
          <label>Outline color</label>
          <input type="color" id="district-outline" value="#000000" />
        </div>
        <div class="form-row">
          <label>Outline thickness</label>
          <input type="number" id="district-weight" value="2" min="0" max="10" style="width:80px" />
        </div>
        <div class="form-row">
          <label>Fill color</label>
          <input type="color" id="district-fill" value="#000000" />
        </div>
        <div class="form-row">
          <label style="width:100px">Transparency (fill)</label>
          <input type="range" id="district-opacity" min="0" max="1" step="0.01" value="1" />
        </div>

        <div class="form-row">
          <button class="btn-draw" id="draw-district">Draw</button>
          <button class="btn-clear" id="clear-district">Clear</button>
        </div>
      </div>
    </section>

    <!-- Assembly panel -->
    <section class="panel" id="assembly-panel">
      <h3>Assemblies</h3>
      <div class="controls">
        <label class="small">Choose Assembly(s)</label>
        <select id="assembly-select" multiple></select>

        <div class="form-row">
          <label>Outline color</label>
          <input type="color" id="assembly-outline" value="#000000" />
        </div>
        <div class="form-row">
          <label>Outline thickness</label>
          <input type="number" id="assembly-weight" value="2" min="0" max="10" style="width:80px" />
        </div>
        <div class="form-row">
          <label>Fill color</label>
          <input type="color" id="assembly-fill" value="#000000" />
        </div>
        <div class="form-row">
          <label style="width:100px">Transparency (fill)</label>
          <input type="range" id="assembly-opacity" min="0" max="1" step="0.01" value="1" />
        </div>

        <div class="form-row">
          <button class="btn-draw" id="draw-assembly">Draw</button>
          <button class="btn-clear" id="clear-assembly">Clear</button>
        </div>
      </div>
    </section>

    <section class="panel">
      <h3>Hints & Notes</h3>
      <ol>
        <li class="small">GeoJSON files expected at repository root: <code>district_V15.geojson</code> and <code>assembly_V15.geojson</code>.</li>
        <li class="small">Primary key field: <code>Name</code>. Features with null Name are shown as <em>Unnamed &lt;index&gt;</em>.</li>
        <li class="small">Drawing order preserves hierarchy: Districts are added first, Assemblies above them.</li>
      </ol>
    </section>
  </aside>

  <script>
    // Basic map setup
    const map = L.map('map', {minZoom:6, maxZoom:18}).setView([10.85,76.27],7);

    // basemap layers
    const basemaps = {
      'osm': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'Â© OpenStreetMap contributors'}),
      'sat': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19, attribution:'Esri'}),
      'none': L.layerGroup([])
    };

    let currentBasemap = basemaps['osm'];
    currentBasemap.addTo(map);

    document.getElementById('basemap').addEventListener('change', (e)=>{
      if (currentBasemap) map.removeLayer(currentBasemap);
      currentBasemap = basemaps[e.target.value];
      if (currentBasemap) map.addLayer(currentBasemap);
    });

    // LayerGroups to keep control and ordering
    const districtGroup = L.layerGroup().addTo(map); // lower/higher? district is higher than state
    const assemblyGroup = L.layerGroup().addTo(map);

    // store geojson raw for populating selects
    let districtGeo = null;
    let assemblyGeo = null;

    // Helper: safe feature title
    function featureTitle(f, idx){
      const n = f && f.properties && f.properties.Name;
      if (n && String(n).trim()!=='') return String(n);
      return `Unnamed ${idx}`;
    }

    // load geojson files (assumes files are in repo root alongside this index.html)
    async function loadGeoJSON(url){
      try{
        const rsp = await fetch(url);
        if(!rsp.ok) throw new Error('Failed to load '+url+' ('+rsp.status+')');
        return await rsp.json();
      }catch(err){
        console.error(err);
        return null;
      }
    }

    function populateChoice(selectEl, items){
      // items: array of {value,label}
      selectEl.innerHTML='';
      items.forEach(it=>{
        const opt = document.createElement('option'); opt.value = it.value; opt.textContent = it.label;
        selectEl.appendChild(opt);
      });
      // initialize Choices
      if (selectEl._choicesInstance) selectEl._choicesInstance.destroy();
      selectEl._choicesInstance = new Choices(selectEl, {removeItemButton:true, searchEnabled:true, placeholderValue:'Type to search...'});
    }

    (async ()=>{
      districtGeo = await loadGeoJSON('district_V15.geojson');
      assemblyGeo = await loadGeoJSON('assembly_V15.geojson');

      if (districtGeo && districtGeo.features){
        const items = districtGeo.features.map((f,i)=>({value:i, label:featureTitle(f,i)}));
        populateChoice(document.getElementById('district-select'), items);
      }
      if (assemblyGeo && assemblyGeo.features){
        const items = assemblyGeo.features.map((f,i)=>({value:i, label:featureTitle(f,i)}));
        populateChoice(document.getElementById('assembly-select'), items);
      }
    })();

    // utility to style polygons
    function styleFor(kind, options={}){
      // kind: 'district' or 'assembly'
      const outline = document.getElementById(kind+'-outline').value;
      const fill = document.getElementById(kind+'-fill').value;
      const weight = parseFloat(document.getElementById(kind+'-weight').value) || 1;
      const opacity = parseFloat(document.getElementById(kind+'-opacity').value);
      return Object.assign({color:outline, weight:weight, fillColor:fill, fillOpacity:opacity, opacity:1}, options);
    }

    // draw helpers
    function drawFeaturesFromGeo(geo, indices, kind){
      // kind: 'district' or 'assembly'
      if(!geo) return;
      const group = (kind==='district') ? districtGroup : assemblyGroup;
      // for ordering: if district then add first; if assembly then bring to front
      indices.forEach(idx=>{
        const feat = geo.features[idx];
        if(!feat) return;
        const layer = L.geoJSON(feat, {
          style: styleFor(kind),
          onEachFeature: (feature, layer)=>{
            // popup content with controls; unique ids
            const uid = 'popup-'+kind+'-'+Math.random().toString(36).substr(2,9);
            const title = featureTitle(feature, idx);
            const popupHtml = `
              <div style="min-width:220px">
                <strong>${title}</strong><br/>
                <div class="form-row"><label>Outline</label><input id="${uid}-outline" type="color" value="${document.getElementById(kind+'-outline').value}" /></div>
                <div class="form-row"><label>Weight</label><input id="${uid}-weight" type="number" value="${document.getElementById(kind+'-weight').value}" style="width:70px" /></div>
                <div class="form-row"><label>Fill</label><input id="${uid}-fill" type="color" value="${document.getElementById(kind+'-fill').value}" /></div>
                <div class="form-row"><label>Opacity</label><input id="${uid}-opacity" type="range" min="0" max="1" step="0.01" value="${document.getElementById(kind+'-opacity').value}" /></div>
                <div style="margin-top:6px;display:flex;gap:6px"><button id="${uid}-apply">Apply</button><button id="${uid}-close">Close</button></div>
              </div>
            `;
            layer.bindPopup(popupHtml);

            // store meta
            layer._meta = {kind:kind, idx:idx, title:featureTitle(feature, idx)};
            // set event so that when opened we attach handlers
            layer.on('popupopen', (ev)=>{
              const lp = ev.popup;
              const src = lp._source;
              const outlineInp = document.getElementById(uid+'-outline');
              const weightInp = document.getElementById(uid+'-weight');
              const fillInp = document.getElementById(uid+'-fill');
              const opInp = document.getElementById(uid+'-opacity');
              const applyBtn = document.getElementById(uid+'-apply');
              const closeBtn = document.getElementById(uid+'-close');

              if(applyBtn){
                applyBtn.onclick = ()=>{
                  // apply style to this layer overriding global
                  const newStyle = {color: outlineInp.value, weight: parseFloat(weightInp.value)||1, fillColor: fillInp.value, fillOpacity: parseFloat(opInp.value)};
                  try{ src.setStyle(newStyle); }catch(e){
                    // for point/marker
                    if(src.setIcon) console.warn('cannot set style on icon');
                  }
                  lp._close();
                };
              }
              if(closeBtn){ closeBtn.onclick = ()=> lp._close(); }
            });

          }
        });
        // tag layer for later clearing
        layer.eachLayer(l=>{ l._metaKind = kind; l._metaIndex = idx; });
        group.addLayer(layer);
      });

      // enforce drawing order: districts under assemblies
      districtGroup.eachLayer(l=>{ l.eachLayer && l.eachLayer(x=>x.bringToBack && x.bringToBack()); });
      assemblyGroup.eachLayer(l=>{ l.eachLayer && l.eachLayer(x=>x.bringToFront && x.bringToFront()); });

      // fit map to last added feature set (optional)
      try{
        const allBounds = L.featureGroup([districtGroup, assemblyGroup]).getBounds();
        if (allBounds.isValid()) map.fitBounds(allBounds, {padding:[20,20]});
      }catch(e){}
    }

    // draw button handlers
    document.getElementById('draw-district').addEventListener('click', ()=>{
      const sel = document.getElementById('district-select');
      const vals = Array.from(sel.selectedOptions).map(o=>parseInt(o.value));
      drawFeaturesFromGeo(districtGeo, vals, 'district');
    });
    document.getElementById('draw-assembly').addEventListener('click', ()=>{
      const sel = document.getElementById('assembly-select');
      const vals = Array.from(sel.selectedOptions).map(o=>parseInt(o.value));
      drawFeaturesFromGeo(assemblyGeo, vals, 'assembly');
    });

    // clear handlers
    document.getElementById('clear-district').addEventListener('click', ()=>{
      districtGroup.clearLayers();
    });
    document.getElementById('clear-assembly').addEventListener('click', ()=>{
      assemblyGroup.clearLayers();
    });

    // handle popup apply via map 'popupopen' generic (for click customization safety)
    map.on('popupopen', function(e){
      // nothing needed here because layer binds its own popupopen
    });

    // keyboard accessibility: close popup on ESC
    document.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape'){ map.closePopup(); } });

    // small UX: when a panel control changes, update any selected but not-yet drawn styles (no immediate redraw)

    // prevent map controls from covering version overlay
    document.querySelector('.top-right-version').style.pointerEvents='none';

  </script>
</body>
</html>
