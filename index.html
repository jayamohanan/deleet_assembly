<!--
  NOTE: Update the version number below every time you make changes to this file.
  Example: v1.0, v1.1, etc.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>District & Assembly Map Drawer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,Arial}
    #app{display:flex;flex-direction:column;height:100%}
    header{padding:12px;background:#0b5;display:flex;flex-wrap:wrap;gap:8px;align-items:center;position:relative}
    input[type=text]{padding:8px;border-radius:6px;border:1px solid #ccc;min-width:180px}
    button{padding:8px 12px;border-radius:6px;border:none;background:#075;color:white;cursor:pointer}
    label{margin-right:4px}
    #status{margin-left:8px;font-size:0.95rem;color:#080}
    #map{flex:1}
    #note{padding:6px 12px;color:#900;white-space:pre-line}
    #version{position:absolute;right:12px;top:12px;font-size:0.85rem;color:#fff;background:#333;padding:4px 8px;border-radius:6px}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div>
        <label for="districtInput">District:</label>
        <input id="districtInput" list="districtList" placeholder="District name">
        <datalist id="districtList"></datalist>
        <button id="drawDistrictBtn">Draw District</button>
        <label>Color:<input type="color" id="districtColor" value="#ff0000"></label>
        <label>Transparency:<input type="range" id="districtOpacity" min="0" max="1" step="0.1" value="0.2"></label>
      </div>
      <div>
        <label for="assemblyInput">Assembly:</label>
        <input id="assemblyInput" list="assemblyList" placeholder="Assembly name">
        <datalist id="assemblyList"></datalist>
        <button id="drawAssemblyBtn">Draw Assembly</button>
        <label>Color:<input type="color" id="assemblyColor" value="#ff0000"></label>
        <label>Transparency:<input type="range" id="assemblyOpacity" min="0" max="1" step="0.1" value="0.2"></label>
      </div>
      <div id="status"></div>
      <div id="version">v1.1</div>
    </header>
    <div id="map"></div>
    <div id="note"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const DISTRICT_URL = 'district12_V3.geojson';
    const ASSEMBLY_URL = 'assembly12_V3.geojson';

    const map = L.map('map', {minZoom: 6}).setView([10.85, 76.27], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    let geoDistrict = null;
    let geoAssembly = null;
    let districtLayer = null;
    let assemblyLayer = null;

    const districtInput = document.getElementById('districtInput');
    const districtList = document.getElementById('districtList');
    const drawDistrictBtn = document.getElementById('drawDistrictBtn');
    const districtColor = document.getElementById('districtColor');
    const districtOpacity = document.getElementById('districtOpacity');

    const assemblyInput = document.getElementById('assemblyInput');
    const assemblyList = document.getElementById('assemblyList');
    const drawAssemblyBtn = document.getElementById('drawAssemblyBtn');
    const assemblyColor = document.getElementById('assemblyColor');
    const assemblyOpacity = document.getElementById('assemblyOpacity');

    const status = document.getElementById('status');
    const note = document.getElementById('note');

    function logMessage(msg, isError=false){
      note.style.color = isError ? '#900' : '#060';
      note.textContent = msg;
    }

    status.textContent = 'Loading GeoJSON...';

    Promise.all([
      fetch(DISTRICT_URL).then(r=>r.json()),
      fetch(ASSEMBLY_URL).then(r=>r.json())
    ]).then(([djson,ajson])=>{
      geoDistrict = djson;
      geoAssembly = ajson;
      status.textContent = 'GeoJSON loaded.';
      populateDatalist(geoDistrict,districtList, true);
      populateDatalist(geoAssembly,assemblyList, true);
    }).catch(err=>{
      logMessage('Error loading geojson: '+err.message,true);
      console.error(err);
    });

    const LIKELY_NAME_KEYS = ['NAME','Name','name','DISTRICT','District','district','DISTRICT_NAME','DIST_NAME','NAME_1','AC_NAME','ACNAME'];

    function getFeatureName(feature){
      if(!feature || !feature.properties) return null;
      for(const k of LIKELY_NAME_KEYS){
        if(k in feature.properties){
          const v = feature.properties[k];
          if(typeof v === 'string' && v.trim().length>0) return v.trim();
        }
      }
      for(const k in feature.properties){
        const v = feature.properties[k];
        if(typeof v === 'string' && v.trim().length>0) return v.trim();
      }
      return null;
    }

    function populateDatalist(geojson, listElem, addNoMap=false){
      const names = new Set();
      if(!geojson.features) return;
      for(const f of geojson.features){
        const n = getFeatureName(f);
        if(n) names.add(n);
      }
      if(addNoMap) names.add('no map');
      Array.from(names).sort().forEach(n=>{
        const opt=document.createElement('option');
        opt.value=n;
        listElem.appendChild(opt);
      });
    }

    function drawLayer(query, geojson, layerVarName, color, opacity, label){
      if(query.toLowerCase() === 'no map'){
        if(window[layerVarName]){
          map.removeLayer(window[layerVarName]);
          window[layerVarName] = null;
          logMessage(label+' map removed.');
        } else {
          logMessage(label+' map already not present.');
        }
        return;
      }
      if(!geojson){ logMessage(label+' GeoJSON not loaded.',true); return; }

      const matched = geojson.features.filter(f => {
        const n = getFeatureName(f);
        return n && n.toLowerCase() === query.toLowerCase();
      });
      if(matched.length === 0){ logMessage('No '+label+' found for: '+query,true); return; }

      if(window[layerVarName]) map.removeLayer(window[layerVarName]);

      window[layerVarName] = L.geoJSON(matched, {
        style: {color: color, weight: 2, fillColor: color, fillOpacity: opacity},
        onEachFeature: (feature, layer)=>{
          const n = getFeatureName(feature) || 'Unknown';
          layer.bindPopup('<b>'+label+': '+n+'</b>');
        }
      }).addTo(map);
      map.fitBounds(window[layerVarName].getBounds().pad(0.1));
      logMessage(label+' drawn: '+query);
    }

    drawDistrictBtn.addEventListener('click', ()=>{
      const q = districtInput.value.trim();
      drawLayer(q, geoDistrict, 'districtLayer', districtColor.value, parseFloat(districtOpacity.value), 'District');
    });

    drawAssemblyBtn.addEventListener('click', ()=>{
      const q = assemblyInput.value.trim();
      drawLayer(q, geoAssembly, 'assemblyLayer', assemblyColor.value, parseFloat(assemblyOpacity.value), 'Assembly');
    });

    districtInput.addEventListener('keydown', e=>{if(e.key==='Enter') drawDistrictBtn.click();});
    assemblyInput.addEventListener('keydown', e=>{if(e.key==='Enter') drawAssemblyBtn.click();});

    if(location.protocol==='file:'){
      logMessage('Tip: run a local server (python -m http.server) if geojson fails to load.',false);
    }
  </script>
</body>
</html>
